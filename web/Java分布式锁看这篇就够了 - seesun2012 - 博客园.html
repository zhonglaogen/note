<!DOCTYPE html>
<!-- saved from url=(0049)https://www.cnblogs.com/seesun2012/p/9214653.html -->
<html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="referrer" content="origin">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <title>Java分布式锁看这篇就够了 - seesun2012 - 博客园</title>
    <meta property="og:description" content="原文出自：https://blog.csdn.net/seesun2012 什么是锁？ 在单进程的系统中，当存在多个线程可以同时改变某个变量（可变共享变量）时，就需要对变量或代码块做同步，使其在修改这">
    <link type="text/css" rel="stylesheet" href="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/blog-common.css">
<link id="MainCss" type="text/css" rel="stylesheet" href="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/bundle-BlueFresh.css">
<link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/bundle-BlueFresh-mobile.css">
    <link title="RSS" type="application/rss+xml" rel="alternate" href="https://www.cnblogs.com/seesun2012/rss">
    <link title="RSD" type="application/rsd+xml" rel="EditURI" href="https://www.cnblogs.com/seesun2012/rsd.xml">
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="https://www.cnblogs.com/seesun2012/wlwmanifest.xml">
    <script src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/amp4ads-host-v0.js"></script><script src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/pubads_impl_rendering_2019080501.js"></script><script async="" src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/analytics.js"></script><script src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/jquery-2.2.0.min.js"></script>
    <script>var currentBlogId=439779;var currentBlogApp='seesun2012',cb_enable_mathjax=true;var isLogined=false;</script>
    <script type="text/x-mathjax-config;executed=true">
    MathJax.Hub.Config({
        tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']], processClass: 'math', processEscapes: true },
        TeX: { 
            equationNumbers: { autoNumber: ['AMS'], useLabelIds: true }, 
            extensions: ['extpfeil.js'],
            Macros: {bm: "\\boldsymbol"}
        },
        'HTML-CSS': { linebreaks: { automatic: true } },
        SVG: { linebreaks: { automatic: true } }
        });
    </script><script src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/MathJax.js"></script>
<script src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/blog-common.js" type="text/javascript"></script>
<link rel="preload" href="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/f.txt" as="script"><script type="text/javascript" src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/f.txt"></script><script src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/pubads_impl_2019080501.js" async=""></script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><link rel="prefetch" href="https://tpc.googlesyndication.com/safeframe/1-0-35/html/container.html"><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head>
<body><div id="MathJax_Message" style="display: none;"></div>
<a name="top"></a>


<!--done-->
<div id="home">
<div id="header">
	<div id="blogTitle">
	<a id="lnkBlogLogo" href="https://www.cnblogs.com/seesun2012/"><img id="blogLogo" src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/logo.gif" alt="返回主页"></a>			
		
<!--done-->
<h1><a id="Header1_HeaderTitle" class="headermaintitle" href="https://www.cnblogs.com/seesun2012/">seesun2012</a></h1>
<h2></h2>



		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">
<li><a id="blog_nav_sitehome" class="menu" href="https://www.cnblogs.com/">博客园</a></li>
<li><a id="blog_nav_myhome" class="menu" href="https://www.cnblogs.com/seesun2012/">首页</a></li>
<li><a id="blog_nav_newpost" class="menu" rel="nofollow" href="https://i.cnblogs.com/EditPosts.aspx?opt=1">新随笔</a></li>
<li><a id="blog_nav_contact" class="menu" rel="nofollow" href="https://msg.cnblogs.com/send/seesun2012">联系</a></li>
<li><a id="blog_nav_rss" class="menu" href="https://www.cnblogs.com/seesun2012/rss">订阅</a>
<!--<a id="blog_nav_rss_image" class="aHeaderXML" href="https://www.cnblogs.com/seesun2012/rss"><img src="//www.cnblogs.com/images/xml.gif" alt="订阅" /></a>--></li>
<li><a id="blog_nav_admin" class="menu" rel="nofollow" href="https://i.cnblogs.com/">管理</a></li>
</ul>
		<div class="blogStats">
			
			<div id="blog_stats">
<span id="stats_post_count">随笔 - 26&nbsp; </span>
<span id="stats_article_count">文章 - 0&nbsp; </span>
<span id="stats-comment_count">评论 - 3</span>
</div>
			
		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->

<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		
        <div id="post_detail">
<!--done-->
<div id="topics">
	<div class="post">
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="https://www.cnblogs.com/seesun2012/p/9214653.html">Java分布式锁看这篇就够了</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown"><p>原文出自：https://blog.csdn.net/seesun2012<br></p>
<h2 id="什么是锁">### 什么是锁？</h2>
<ul>
<li>在单进程的系统中，当存在多个线程可以同时改变某个变量（可变共享变量）时，就需要对变量或代码块做同步，使其在修改这种变量时能够线性执行消除并发修改变量。</li>
<li>而同步的本质是通过锁来实现的。为了实现多个线程在一个时刻同一个代码块只能有一个线程可执行，那么需要在某个地方做个标记，这个标记必须每个线程都能看到，当标记不存在时可以设置该标记，其余后续线程发现已经有标记了则等待拥有标记的线程结束同步代码块取消标记后再去尝试设置标记。这个标记可以理解为锁。</li>
<li>不同地方实现锁的方式也不一样，只要能满足所有线程都能看得到标记即可。如 Java 中 synchronize 是在对象头设置标记，Lock 接口的实现类基本上都只是某一个 volitile 修饰的 int 型变量其保证每个线程都能拥有对该 int 的可见性和原子修改，linux 内核中也是利用互斥量或信号量等内存数据做标记。</li>
<li>除了利用内存数据做锁其实任何互斥的都能做锁（只考虑互斥情况），如流水表中流水号与时间结合做幂等校验可以看作是一个不会释放的锁，或者使用某个文件是否存在作为锁等。只需要满足在对标记进行修改能保证原子性和内存可见性即可。</li>
</ul>
<h2 id="什么是分布式">### 什么是分布式？</h2>
<p>分布式的 CAP 理论告诉我们:</p>
<blockquote>
<p>任何一个分布式系统都无法同时满足一致性（Consistency）、可用性（Availability）和分区容错性（Partition tolerance），最多只能同时满足两项。</p>
</blockquote>
<p>目前很多大型网站及应用都是分布式部署的，分布式场景中的数据一致性问题一直是一个比较重要的话题。基于 CAP理论，很多系统在设计之初就要对这三者做出取舍。在互联网领域的绝大多数的场景中，都需要牺牲强一致性来换取系统的高可用性，系统往往只需要保证最终一致性。</p>
<p>分布式场景</p>
<hr>
<blockquote>
<p>此处主要指集群模式下，多个相同服务同时开启.</p>
</blockquote>
<p>在许多的场景中，我们为了保证数据的最终一致性，需要很多的技术方案来支持，比如<code>分布式事务</code>、<code>分布式锁</code>等。很多时候我们需要保证一个方法在同一时间内只能被同一个线程执行。在单机环境中，通过 Java 提供的并发 API 我们可以解决，但是在分布式环境下，就没有那么简单啦。</p>
<ul>
<li>分布式与单机情况下最大的不同在于其不是多线程而是<code>多进程</code>。</li>
<li>多线程由于可以共享堆内存，因此可以简单的采取内存作为标记存储位置。而进程之间甚至可能都不在同一台物理机上，因此需要将标记存储在一个所有进程都能看到的地方。</li>
<li><h3 id="什么是分布式锁">什么是分布式锁？</h3></li>
</ul>
<hr>
<ul>
<li>当在分布式模型下，数据只有一份（或有限制），此时需要利用锁的技术控制某一时刻修改数据的进程数。</li>
<li>与单机模式下的锁不仅需要保证进程可见，还需要考虑进程与锁之间的网络问题。（我觉得分布式情况下之所以问题变得复杂，主要就是需要考虑到网络的延时和不可靠。。。一个大坑）</li>
<li>分布式锁还是可以将标记存在内存，只是该内存不是某个进程分配的内存而是公共内存如 Redis、Memcache。至于利用数据库、文件等做锁与单机的实现是一样的，只要保证标记能互斥就行。</li>
</ul>
<h2 id="我们需要怎样的分布式锁">### 我们需要怎样的分布式锁？</h2>
<ul>
<li>可以保证在分布式部署的应用集群中，同一个方法在同一时间只能被一台机器-上的一个线程执行。</li>
<li>这把锁要是一把可重入锁（避免死锁）</li>
<li>这把锁最好是一把阻塞锁（根据业务需求考虑要不要这条）</li>
<li>这把锁最好是一把公平锁（根据业务需求考虑要不要这条）</li>
<li>有高可用的获取锁和释放锁功能</li>
<li>获取锁和释放锁的性能要好</li>
</ul>
<h2 id="基于数据库做分布式锁">### 基于数据库做分布式锁</h2>
<blockquote>
<p>基于乐观锁</p>
</blockquote>
<h5 id="基于表主键唯一做分布式锁">基于表主键唯一做分布式锁</h5>
<p><strong>思路：</strong>利用主键唯一的特性，如果有多个请求同时提交到数据库的话，数据库会保证只有一个操作可以成功，那么我们就可以认为操作成功的那个线程获得了该方法的锁，当方法执行完毕之后，想要释放锁的话，删除这条数据库记录即可。</p>
<p>上面这种简单的实现有以下几个问题：</p>
<ul>
<li>这把锁强依赖数据库的可用性，数据库是一个单点，一旦数据库挂掉，会导致业务系统不可用。</li>
<li>这把锁没有失效时间，一旦解锁操作失败，就会导致锁记录一直在数据库中，其他线程无法再获得到锁。</li>
<li>这把锁只能是非阻塞的，因为数据的 insert操作，一旦插入失败就会直接报错。没有获得锁的线程并不会进入排队队列，要想再次获得锁就要再次触发获得锁操作。</li>
<li>这把锁是非重入的，同一个线程在没有释放锁之前无法再次获得该锁。因为数据中数据已经存在了。</li>
<li>这把锁是非公平锁，所有等待锁的线程凭运气去争夺锁。</li>
<li>在 MySQL 数据库中采用主键冲突防重，在大并发情况下有可能会造成锁表现象。</li>
</ul>
<h5 id="当然我们也可以有其他方式解决上面的问题">当然，我们也可以有其他方式解决上面的问题。</h5>
<ul>
<li>数据库是单点？搞两个数据库，数据之前双向同步，一旦挂掉快速切换到备库上。</li>
<li>没有失效时间？只要做一个定时任务，每隔一定时间把数据库中的超时数据清理一遍。</li>
<li>非阻塞的？搞一个 while 循环，直到 insert 成功再返回成功。</li>
<li>非重入的？在数据库表中加个字段，记录当前获得锁的机器的主机信息和线程信息，那么下次再获取锁的时候先查询数据库，如果当前机器的主机信息和线程信息在数据库可以查到的话，直接把锁分配给他就可以了。</li>
<li>非公平的？再建一张中间表，将等待锁的线程全记录下来，并根据创建时间排序，只有最先创建的允许获取锁。</li>
<li>比较好的办法是在程序中生产主键进行防重。</li>
</ul>
<h2 id="基于表字段版本号做分布式锁">##### 基于表字段版本号做分布式锁</h2>
<p>这个策略源于 mysql 的 mvcc 机制，使用这个策略其实本身没有什么问题，唯一的问题就是对数据表侵入较大，我们要为每个表设计一个版本号字段，然后写一条判断 sql 每次进行判断，增加了数据库操作的次数，在高并发的要求下，对数据库连接的开销也是无法忍受的。</p>
<blockquote>
<p>基于悲观锁</p>
</blockquote>
<h2 id="基于数据库排他锁做分布式锁">##### 基于数据库排他锁做分布式锁</h2>
<p>在查询语句后面增加<code>for update</code>，数据库会在查询过程中给数据库表增加排他锁 (注意： InnoDB 引擎在加锁的时候，只有通过索引进行检索的时候才会使用行级锁，否则会使用表级锁。这里我们希望使用行级锁，就要给要执行的方法字段名添加索引，值得注意的是，这个索引一定要创建成唯一索引，否则会出现多个重载方法之间无法同时被访问的问题。重载方法的话建议把参数类型也加上。)。当某条记录被加上排他锁之后，其他线程无法再在该行记录上增加排他锁。<br><br><br>
我们可以认为获得排他锁的线程即可获得分布式锁，当获取到锁之后，可以执行方法的业务逻辑，执行完方法之后，通过<code>connection.commit()</code>操作来释放锁。<br><br><br>
这种方法可以有效的解决上面提到的无法释放锁和阻塞锁的问题。</p>
<ul>
<li>阻塞锁？ <code>for update</code>语句会在执行成功后立即返回，在执行失败时一直处于阻塞状态，直到成功。</li>
<li>锁定之后服务宕机，无法释放？使用这种方式，服务宕机之后数据库会自己把锁释放掉。</li>
</ul>
<p>但是还是无法直接解决数据库单点和可重入问题。</p>
<p>这里还可能存在另外一个问题，虽然我们对方法字段名使用了唯一索引，并且显示使用 for update 来使用行级锁。但是，MySQL 会对查询进行优化，即便在条件中使用了索引字段，但是否使用索引来检索数据是由 MySQL 通过判断不同执行计划的代价来决定的，如果 MySQL 认为全表扫效率更高，比如对一些很小的表，它就不会使用索引，这种情况下 InnoDB 将使用表锁，而不是行锁。如果发生这种情况就悲剧了。。。</p>
<p>还有一个问题，就是我们要使用排他锁来进行分布式锁的 lock，那么一个排他锁长时间不提交，就会占用数据库连接。一旦类似的连接变得多了，就可能把数据库连接池撑爆。</p>
<h2 id="优缺点">##### 优缺点</h2>
<p><strong>优点</strong>：简单，易于理解<br><br><br>
<strong>缺点</strong>：会有各种各样的问题（操作数据库需要一定的开销，使用数据库的行级锁并不一定靠谱，性能不靠谱）</p>
<h2 id="基于-redis-做分布式锁">### 基于 Redis 做分布式锁</h2>
<p><strong>基于 REDIS 的 SETNX()、EXPIRE() 方法做分布式锁</strong></p>
<hr>
<p><strong>setnx()</strong></p>
<hr>
<p>setnx 的含义就是 SET if Not Exists，其主要有两个参数 setnx(key, value)。该方法是原子的，如果 key 不存在，则设置当前 key 成功，返回 1；如果当前 key 已经存在，则设置当前 key 失败，返回 0。</p>
<p><strong>expire()</strong></p>
<hr>
<p>expire 设置过期时间，要注意的是 setnx 命令不能设置 key 的超时时间，只能通过 expire() 来对 key 设置。</p>
<p><strong>使用步骤</strong></p>
<hr>
<p>1、setnx(lockkey, 1) 如果返回 0，则说明占位失败；如果返回 1，则说明占位成功</p>
<p>2、expire() 命令对 lockkey 设置超时时间，为的是避免死锁问题。</p>
<p>3、执行完业务代码后，可以通过 delete 命令删除 key。</p>
<p>这个方案其实是可以解决日常工作中的需求的，但从技术方案的探讨上来说，可能还有一些可以完善的地方。<strong>比如，如果在第一步 setnx 执行成功后，在 expire() 命令执行成功前，发生了宕机的现象，那么就依然会出现死锁的问题，所以如果要对其进行完善的话，可以使用 redis 的 setnx()、get() 和 getset() 方法来实现分布式锁。</strong></p>
<p><strong>基于 REDIS 的 SETNX()、GET()、GETSET()方法做分布式锁</strong></p>
<hr>
<p>这个方案的背景主要是在 setnx() 和 expire() 的方案上针对可能存在的死锁问题，做了一些优化。</p>
<p><strong>getset()</strong></p>
<hr>
<p>这个命令主要有两个参数 getset(key，newValue)。该方法是原子的，对 key 设置 newValue 这个值，并且返回 key 原来的旧值。假设 key 原来是不存在的，那么多次执行这个命令，会出现下边的效果：</p>
<ul>
<li>getset(key, “value1”) 返回 null 此时 key 的值会被设置为 value1</li>
<li>getset(key, “value2”) 返回 value1 此时 key 的值会被设置为 value2</li>
<li>依次类推！</li>
</ul>
<p><strong>使用步骤</strong></p>
<hr>
<ul>
<li>setnx(lockkey, 当前时间+过期超时时间)，如果返回 1，则获取锁成功；如果返回 0 则没有获取到锁，转向 2。</li>
<li>get(lockkey) 获取值 oldExpireTime ，并将这个 value 值与当前的系统时间进行比较，如果小于当前系统时间，则认为这个锁已经超时，可以允许别的请求重新获取，转向 3。</li>
<li>计算 newExpireTime = 当前时间+过期超时时间，然后 getset(lockkey, newExpireTime) 会返回当前 lockkey 的值currentExpireTime。</li>
<li>判断 currentExpireTime 与 oldExpireTime 是否相等，如果相等，说明当前 getset 设置成功，获取到了锁。如果不相等，说明这个锁又被别的请求获取走了，那么当前请求可以直接返回失败，或者继续重试。</li>
<li>在获取到锁之后，当前线程可以开始自己的业务处理，当处理完毕后，比较自己的处理时间和对于锁设置的超时时间，如果小于锁设置的超时时间，则直接执行 delete 释放锁；如果大于锁设置的超时时间，则不需要再锁进行处理。</li>
</ul>
<pre><code class="hljs java"><span class="hljs-keyword">import</span> cn.com.tpig.cache.redis.RedisService;
<span class="hljs-keyword">import</span> cn.com.tpig.utils.SpringUtils;

<span class="hljs-comment">//redis分布式锁</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisLockUtil</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> defaultExpire = <span class="hljs-number">60</span>;

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">RedisLockUtil</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">//</span>
    }

    <span class="hljs-comment">/**
     * 加锁
     * <span class="hljs-doctag">@param</span> key redis key
     * <span class="hljs-doctag">@param</span> expire 过期时间，单位秒
     * <span class="hljs-doctag">@return</span> true:加锁成功，false，加锁失败
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">lock</span><span class="hljs-params">(String key, <span class="hljs-keyword">int</span> expire)</span> </span>{

        RedisService redisService = SpringUtils.getBean(RedisService.class);
        <span class="hljs-keyword">long</span> status = redisService.setnx(key, <span class="hljs-string">"1"</span>);

        <span class="hljs-keyword">if</span>(status == <span class="hljs-number">1</span>) {
            redisService.expire(key, expire);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">lock</span><span class="hljs-params">(String key)</span> </span>{
        <span class="hljs-keyword">return</span> lock2(key, defaultExpire);
    }

    <span class="hljs-comment">/**
     * 加锁
     * <span class="hljs-doctag">@param</span> key redis key
     * <span class="hljs-doctag">@param</span> expire 过期时间，单位秒
     * <span class="hljs-doctag">@return</span> true:加锁成功，false，加锁失败
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">lock2</span><span class="hljs-params">(String key, <span class="hljs-keyword">int</span> expire)</span> </span>{

        RedisService redisService = SpringUtils.getBean(RedisService.class);

        <span class="hljs-keyword">long</span> value = System.currentTimeMillis() + expire;
        <span class="hljs-keyword">long</span> status = redisService.setnx(key, String.valueOf(value));

        <span class="hljs-keyword">if</span>(status == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        }
        <span class="hljs-keyword">long</span> oldExpireTime = Long.parseLong(redisService.get(key, <span class="hljs-string">"0"</span>));
        <span class="hljs-keyword">if</span>(oldExpireTime &lt; System.currentTimeMillis()) {
            <span class="hljs-comment">//超时</span>
            <span class="hljs-keyword">long</span> newExpireTime = System.currentTimeMillis() + expire;
            <span class="hljs-keyword">long</span> currentExpireTime = Long.parseLong(redisService.getSet(key, String.valueOf(newExpireTime)));
            <span class="hljs-keyword">if</span>(currentExpireTime == oldExpireTime) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unLock1</span><span class="hljs-params">(String key)</span> </span>{
        RedisService redisService = SpringUtils.getBean(RedisService.class);
        redisService.del(key);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unLock2</span><span class="hljs-params">(String key)</span> </span>{    
        RedisService redisService = SpringUtils.getBean(RedisService.class);    
        <span class="hljs-keyword">long</span> oldExpireTime = Long.parseLong(redisService.get(key, <span class="hljs-string">"0"</span>));   
        <span class="hljs-keyword">if</span>(oldExpireTime &gt; System.currentTimeMillis()) {        
            redisService.del(key);    
        }
   }
}</code></pre>
<pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">drawRedPacket</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> userId</span>) </span>{
    String key = <span class="hljs-string">"draw.redpacket.userid:"</span> + userId;

    boolean <span class="hljs-keyword">lock</span> = RedisLockUtil.lock2(key, <span class="hljs-number">60</span>);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">lock</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//领取操作</span>
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">//释放锁</span>
            RedisLockUtil.unLock(key);
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"重复领取奖励"</span>);
    }
}</code></pre>
<p><strong>基于 REDLOCK 做分布式锁</strong></p>
<hr>
<p>Redlock 是 Redis 的作者 antirez 给出的集群模式的 Redis 分布式锁，它基于 N 个完全独立的 Redis 节点（通常情况下 N 可以设置成 5）。</p>
<p>算法的步骤如下：</p>
<ul>
<li>1、客户端获取当前时间，以毫秒为单位。</li>
<li>2、客户端尝试获取 N 个节点的锁，（每个节点获取锁的方式和前面说的缓存锁一样），N 个节点以相同的 key 和 value 获取锁。客户端需要设置接口访问超时，接口超时时间需要远远小于锁超时时间，比如锁自动释放的时间是 10s，那么接口超时大概设置 5-50ms。这样可以在有 redis 节点宕机后，访问该节点时能尽快超时，而减小锁的正常使用。</li>
<li>3、客户端计算在获得锁的时候花费了多少时间，方法是用当前时间减去在步骤一获取的时间，只有客户端获得了超过 3 个节点的锁，而且获取锁的时间小于锁的超时时间，客户端才获得了分布式锁。</li>
<li>4、客户端获取的锁的时间为设置的锁超时时间减去步骤三计算出的获取锁花费时间。</li>
<li>5、如果客户端获取锁失败了，客户端会依次删除所有的锁。</li>
</ul>
<p>使用 Redlock 算法，可以保证在挂掉最多 2 个节点的时候，分布式锁服务仍然能工作，这相比之前的数据库锁和缓存锁大大提高了可用性，由于 redis 的高效性能，分布式缓存锁性能并不比数据库锁差。</p>
<p>但是，有一位分布式的专家写了一篇文章《How to do distributed locking》，质疑 Redlock 的正确性。</p>
<p>https://mp.weixin.qq.com/s/1bPLk_VZhZ0QYNZS8LkviA</p>
<p>https://blog.csdn.net/jek123456/article/details/72954106</p>
<h5 id="优缺点-1">优缺点</h5>
<hr>
<p><strong>优点：</strong> 性能高</p>
<p><strong>缺点：</strong><br></p>
<p>失效时间设置多长时间为好？如何设置的失效时间太短，方法没等执行完，锁就自动释放了，那么就会产生并发问题。如果设置的时间太长，其他获取锁的线程就可能要平白的多等一段时间。</p>
<h5 id="基于-redisson-做分布式锁">基于 REDISSON 做分布式锁</h5>
<hr>
<p>redisson 是 redis 官方的分布式锁组件。GitHub 地址：https://github.com/redisson/redisson</p>
<p>上面的这个问题 ——&gt; 失效时间设置多长时间为好？这个问题在 redisson 的做法是：每获得一个锁时，只设置一个很短的超时时间，同时起一个线程在每次快要到超时时间时去刷新锁的超时时间。在释放锁的同时结束这个线程。</p>
<h3 id="基于-zookeeper-做分布式锁">基于 ZooKeeper 做分布式锁</h3>
<hr>
<h5 id="zookeeper-锁相关基础知识">ZOOKEEPER 锁相关基础知识</h5>
<hr>
<ul>
<li>zk 一般由多个节点构成（单数），采用 zab 一致性协议。因此可以将 zk 看成一个单点结构，对其修改数据其内部自动将所有节点数据进行修改而后才提供查询服务。</li>
<li>zk 的数据以目录树的形式，每个目录称为 znode， znode 中可存储数据（一般不超过 1M），还可以在其中增加子节点。</li>
<li>子节点有三种类型。序列化节点，每在该节点下增加一个节点自动给该节点的名称上自增。临时节点，一旦创建这个 znode 的客户端与服务器失去联系，这个 znode 也将自动删除。最后就是普通节点。</li>
<li>Watch 机制，client 可以监控每个节点的变化，当产生变化会给 client 产生一个事件。</li>
</ul>
<h5 id="zk-基本锁">ZK 基本锁</h5>
<hr>
<ul>
<li>原理：利用临时节点与 watch 机制。每个锁占用一个普通节点 /lock，当需要获取锁时在 /lock 目录下创建一个临时节点，创建成功则表示获取锁成功，失败则 watch/lock 节点，有删除操作后再去争锁。临时节点好处在于当进程挂掉后能自动上锁的节点自动删除即取消锁。</li>
<li>缺点：所有取锁失败的进程都监听父节点，很容易发生羊群效应，即当释放锁后所有等待进程一起来创建节点，并发量很大。</li>
</ul>
<h5 id="zk-锁优化">ZK 锁优化</h5>
<hr>
<ul>
<li>原理：上锁改为创建临时有序节点，每个上锁的节点均能创建节点成功，只是其序号不同。只有序号最小的可以拥有锁，如果这个节点序号不是最小的则 watch 序号比本身小的前一个节点 (公平锁)。</li>
</ul>
<p>步骤：</p>
<ul>
<li>1.在 /lock 节点下创建一个有序临时节点 (EPHEMERAL_SEQUENTIAL)。</li>
<li>2.判断创建的节点序号是否最小，如果是最小则获取锁成功。不是则取锁失败，然后 watch 序号比本身小的前一个节点。</li>
<li>3.当取锁失败，设置 watch 后则等待 watch 事件到来后，再次判断是否序号最小。</li>
<li>4.取锁成功则执行代码，最后释放锁（删除该节点）。</li>
</ul>
<pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;
<span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;
<span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;

<span class="hljs-keyword">import</span> org.apache.zookeeper.CreateMode;
<span class="hljs-keyword">import</span> org.apache.zookeeper.KeeperException;
<span class="hljs-keyword">import</span> org.apache.zookeeper.WatchedEvent;
<span class="hljs-keyword">import</span> org.apache.zookeeper.Watcher;
<span class="hljs-keyword">import</span> org.apache.zookeeper.ZooDefs;
<span class="hljs-keyword">import</span> org.apache.zookeeper.ZooKeeper;
<span class="hljs-keyword">import</span> org.apache.zookeeper.data.Stat;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DistributedLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Lock</span>, <span class="hljs-title">Watcher</span></span>{
    <span class="hljs-keyword">private</span> ZooKeeper zk;
    <span class="hljs-keyword">private</span> String root = <span class="hljs-string">"/locks"</span>;<span class="hljs-comment">//根</span>
    <span class="hljs-keyword">private</span> String lockName;<span class="hljs-comment">//竞争资源的标志</span>
    <span class="hljs-keyword">private</span> String waitNode;<span class="hljs-comment">//等待前一个锁</span>
    <span class="hljs-keyword">private</span> String myZnode;<span class="hljs-comment">//当前锁</span>
    <span class="hljs-keyword">private</span> CountDownLatch latch;<span class="hljs-comment">//计数器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> sessionTimeout = <span class="hljs-number">30000</span>;
    <span class="hljs-keyword">private</span> List&lt;Exception&gt; exception = <span class="hljs-keyword">new</span> ArrayList&lt;Exception&gt;();

    <span class="hljs-comment">/**
     * 创建分布式锁,使用前请确认config配置的zookeeper服务可用
     * <span class="hljs-doctag">@param</span> config 127.0.0.1:2181
     * <span class="hljs-doctag">@param</span> lockName 竞争资源标志,lockName中不能包含单词lock
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DistributedLock</span><span class="hljs-params">(String config, String lockName)</span></span>{
        <span class="hljs-keyword">this</span>.lockName = lockName;
        <span class="hljs-comment">// 创建一个与服务器的连接</span>
        <span class="hljs-keyword">try</span> {
            zk = <span class="hljs-keyword">new</span> ZooKeeper(config, sessionTimeout, <span class="hljs-keyword">this</span>);
            Stat stat = zk.exists(root, <span class="hljs-keyword">false</span>);
            <span class="hljs-keyword">if</span>(stat == <span class="hljs-keyword">null</span>){
                <span class="hljs-comment">// 创建根节点</span>
                zk.create(root, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">0</span>], ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            exception.add(e);
        } <span class="hljs-keyword">catch</span> (KeeperException e) {
            exception.add(e);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            exception.add(e);
        }
    }

    <span class="hljs-comment">/**
     * zookeeper节点的监视器
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(WatchedEvent event)</span> </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.latch != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">this</span>.latch.countDown();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span>(exception.size() &gt; <span class="hljs-number">0</span>){
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LockException(exception.get(<span class="hljs-number">0</span>));
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.tryLock()){
                System.out.println(<span class="hljs-string">"Thread "</span> + Thread.currentThread().getId() + <span class="hljs-string">" "</span> +myZnode + <span class="hljs-string">" get lock true"</span>);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">else</span>{
                waitForLock(waitNode, sessionTimeout);<span class="hljs-comment">//等待锁</span>
            }
        } <span class="hljs-keyword">catch</span> (KeeperException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LockException(e);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LockException(e);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">try</span> {
            String splitStr = <span class="hljs-string">"_lock_"</span>;
            <span class="hljs-keyword">if</span>(lockName.contains(splitStr))
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LockException(<span class="hljs-string">"lockName can not contains \\u000B"</span>);
            <span class="hljs-comment">//创建临时子节点</span>
            myZnode = zk.create(root + <span class="hljs-string">"/"</span> + lockName + splitStr, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">0</span>], ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.EPHEMERAL_SEQUENTIAL);
            System.out.println(myZnode + <span class="hljs-string">" is created "</span>);
            <span class="hljs-comment">//取出所有子节点</span>
            List&lt;String&gt; subNodes = zk.getChildren(root, <span class="hljs-keyword">false</span>);
            <span class="hljs-comment">//取出所有lockName的锁</span>
            List&lt;String&gt; lockObjNodes = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;();
            <span class="hljs-keyword">for</span> (String node : subNodes) {
                String _node = node.split(splitStr)[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">if</span>(_node.equals(lockName)){
                    lockObjNodes.add(node);
                }
            }
            Collections.sort(lockObjNodes);
            System.out.println(myZnode + <span class="hljs-string">"=="</span> + lockObjNodes.get(<span class="hljs-number">0</span>));
            <span class="hljs-keyword">if</span>(myZnode.equals(root+<span class="hljs-string">"/"</span>+lockObjNodes.get(<span class="hljs-number">0</span>))){
                <span class="hljs-comment">//如果是最小的节点,则表示取得锁</span>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
            }
            <span class="hljs-comment">//如果不是最小的节点，找到比自己小1的节点</span>
            String subMyZnode = myZnode.substring(myZnode.lastIndexOf(<span class="hljs-string">"/"</span>) + <span class="hljs-number">1</span>);
            waitNode = lockObjNodes.get(Collections.binarySearch(lockObjNodes, subMyZnode) - <span class="hljs-number">1</span>);
        } <span class="hljs-keyword">catch</span> (KeeperException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LockException(e);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LockException(e);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(<span class="hljs-keyword">long</span> time, TimeUnit unit)</span> </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.tryLock()){
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
            }
            <span class="hljs-keyword">return</span> waitForLock(waitNode,time);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">waitForLock</span><span class="hljs-params">(String lower, <span class="hljs-keyword">long</span> waitTime)</span> <span class="hljs-keyword">throws</span> InterruptedException, KeeperException </span>{
        Stat stat = zk.exists(root + <span class="hljs-string">"/"</span> + lower,<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">//判断比自己小一个数的节点是否存在,如果不存在则无需等待锁,同时注册监听</span>
        <span class="hljs-keyword">if</span>(stat != <span class="hljs-keyword">null</span>){
            System.out.println(<span class="hljs-string">"Thread "</span> + Thread.currentThread().getId() + <span class="hljs-string">" waiting for "</span> + root + <span class="hljs-string">"/"</span> + lower);
            <span class="hljs-keyword">this</span>.latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);
            <span class="hljs-keyword">this</span>.latch.await(waitTime, TimeUnit.MILLISECONDS);
            <span class="hljs-keyword">this</span>.latch = <span class="hljs-keyword">null</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">try</span> {
            System.out.println(<span class="hljs-string">"unlock "</span> + myZnode);
            zk.delete(myZnode,-<span class="hljs-number">1</span>);
            myZnode = <span class="hljs-keyword">null</span>;
            zk.close();
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        } <span class="hljs-keyword">catch</span> (KeeperException e) {
            e.printStackTrace();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{
        <span class="hljs-keyword">this</span>.lock();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Condition <span class="hljs-title">newCondition</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LockException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RuntimeException</span> </span>{
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">1L</span>;
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LockException</span><span class="hljs-params">(String e)</span></span>{
            <span class="hljs-keyword">super</span>(e);
        }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LockException</span><span class="hljs-params">(Exception e)</span></span>{
            <span class="hljs-keyword">super</span>(e);
        }
    }
}</code></pre>
<h5 id="优缺点-2">优缺点</h5>
<hr>
<h5 id="优点">优点：</h5>
<p>有效的解决单点问题，不可重入问题，非阻塞问题以及锁无法释放的问题。实现起来较为简单。</p>
<h5 id="缺点">缺点：</h5>
<p>性能上可能并没有缓存服务那么高，因为每次在创建锁和释放锁的过程中，都要动态创建、销毁临时节点来实现锁功能。ZK 中创建和删除节点只能通过 Leader 服务器来执行，然后将数据同步到所有的 Follower 机器上。还需要对 ZK的原理有所了解。</p>
<h3 id="基于-consul-做分布式锁">基于 Consul 做分布式锁</h3>
<hr>
<p>DD 写过类似文章，其实主要利用 Consul 的 Key / Value 存储 API 中的 acquire 和 release 操作来实现。</p>
<p>文章地址：http://blog.didispace.com/spring-cloud-consul-lock-and-semphore/</p>
<h5 id="使用分布式锁的注意事项">使用分布式锁的注意事项</h5>
<hr>
<p>1、注意分布式锁的开销</p>
<p>2、注意加锁的粒度</p>
<p>3、加锁的方式</p>
<h3 id="总结">总结</h3>
<hr>
<p>无论你身处一个什么样的公司，最开始的工作可能都需要从最简单的做起。不要提阿里和腾讯的业务场景 qps 如何大，因为在这样的大场景中你未必能亲自参与项目，亲自参与项目未必能是核心的设计者，是核心的设计者未必能独自设计。希望大家能根据自己公司业务场景，选择适合自己项目的方案。</p>
<h3 id="参考资料">参考资料</h3>
<p>http://www.hollischuang.com/archives/1716</p>
<p>http://www.spring4all.com/question/158</p>
<p>https://www.cnblogs.com/PurpleDream/p/5559352.html</p>
<p>http://www.cnblogs.com/PurpleDream/p/5573040.html</p>
<p>https://www.cnblogs.com/suolu/p/6588902.html</p>
<p>原创地址：http://www.54tianzhisheng.cn/2018/04/24/Distributed_lock/</p>
</div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag">标签: <a href="https://www.cnblogs.com/seesun2012/tag/Java/">Java</a>, <a href="https://www.cnblogs.com/seesun2012/tag/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a></div>
<div id="blog_post_info"><div id="green_channel">
        <a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(9214653,cb_blogId,1);green_channel_success(this,&#39;谢谢推荐！&#39;);">好文要顶</a>
            <a id="green_channel_follow" onclick="follow(&#39;264bd5e7-01cd-4a01-efb7-08d5d38bf026&#39;);" href="javascript:void(0);">关注我</a>
    <a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a>
    <a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/icon_weibo_24.png" alt=""></a>
    <a id="green_channel_wechat" href="javascript:void(0);" title="分享至微信" onclick="shareOnWechat()"><img src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/wechat.png" alt=""></a>
</div>
<div id="author_profile">
    <div id="author_profile_info" class="author_profile_info">
            <a href="https://home.cnblogs.com/u/seesun2012/" target="_blank"><img src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/20180622145352.png" class="author_avatar" alt=""></a>
        <div id="author_profile_detail" class="author_profile_info">
            <a href="https://home.cnblogs.com/u/seesun2012/">seesun2012</a><br>
            <a href="https://home.cnblogs.com/u/seesun2012/followees">关注 - 0</a><br>
            <a href="https://home.cnblogs.com/u/seesun2012/followers">粉丝 - 5</a>
        </div>
    </div>
    <div class="clear"></div>
    <div id="author_profile_honor"></div>
    <div id="author_profile_follow">
                <a href="javascript:void(0);" onclick="follow(&#39;264bd5e7-01cd-4a01-efb7-08d5d38bf026&#39;);return false;">+加关注</a>
    </div>
</div>
<div id="div_digg">
    <div class="diggit" onclick="votePost(9214653,&#39;Digg&#39;)">
        <span class="diggnum" id="digg_count">11</span>
    </div>
    <div class="buryit" onclick="votePost(9214653,&#39;Bury&#39;)">
        <span class="burynum" id="bury_count">1</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips">
    </div>
</div>
<script type="text/javascript">
    currentDiggType = 0;
</script></div>
<div class="clear"></div>
<div id="post_next_prev"><a href="https://www.cnblogs.com/seesun2012/p/9214648.html" class="p_n_p_prefix">« </a> 上一篇：<a href="https://www.cnblogs.com/seesun2012/p/9214648.html" title="发布于2018-06-22 17:47">quartz时间配置</a><br><a href="https://www.cnblogs.com/seesun2012/p/9214665.html" class="p_n_p_prefix">» </a> 下一篇：<a href="https://www.cnblogs.com/seesun2012/p/9214665.html" title="发布于2018-06-22 17:50">Java如何实现form表单提交的数据自动对应实体类（源码）</a><br></div>
</div>


		</div>
		<div class="postDesc">posted @ <span id="post-date">2018-06-22 17:48</span> <a href="https://www.cnblogs.com/seesun2012/">seesun2012</a> 阅读(<span id="post_view_count">50455</span>) 评论(<span id="post_comment_count">3</span>)  <a href="https://i.cnblogs.com/EditPosts.aspx?postid=9214653" rel="nofollow">编辑</a> <a href="https://www.cnblogs.com/seesun2012/p/9214653.html#" onclick="AddToWz(9214653);return false;">收藏</a></div>
	</div>
	<script src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/highlight.min.js"></script><script>markdown_highlight();</script><script type="text/javascript">var allowComments=true,cb_blogId=439779,cb_entryId=9214653,cb_blogApp=currentBlogApp,cb_blogUserGuid='264bd5e7-01cd-4a01-efb7-08d5d38bf026',cb_entryCreatedDate='2018/6/22 17:48:00';loadViewCount(cb_entryId);var cb_postType=1;var isMarkdown=true;</script>
	
</div><!--end: topics 文章、评论容器-->
</div><a name="!comments"></a><div id="blog-comments-placeholder"><div id="comments_pager_top"></div>
<br>
<div class="feedback_area_title">评论列表</div>
<div class="feedbackNoItems"></div>	

		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="https://www.cnblogs.com/seesun2012/p/9214653.html#4236490" class="layer">#1楼</a><a name="4236490" id="comment_anchor_4236490"></a>  <span class="comment_date">2019-04-21 16:40</span> <a id="a_comment_author_4236490" href="https://www.cnblogs.com/boycelee/" target="_blank">码头工人</a> <a href="http://msg.cnblogs.com/send/%E7%A0%81%E5%A4%B4%E5%B7%A5%E4%BA%BA" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_4236490" class="blog_comment_body">你好。currentTime != oldTime，使用getset，不就会覆盖超时时间了吗？</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4236490,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(4236490,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_4236490_avatar" style="display:none;">http://pic.cnblogs.com/face/765838/20160616131805.png</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="https://www.cnblogs.com/seesun2012/p/9214653.html#4258684" class="layer">#2楼</a><a name="4258684" id="comment_anchor_4258684"></a>  <span class="comment_date">2019-05-18 09:33</span> <a id="a_comment_author_4258684" href="http://home.cnblogs.com/u/1167932/" target="_blank">hhq1991</a> <a href="http://msg.cnblogs.com/send/hhq1991" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_4258684" class="blog_comment_body"><a href="https://www.cnblogs.com/seesun2012/p/9214653.html#4236490" title="查看所回复的评论" onclick="commentManager.renderComments(0,50,4236490);">@</a>
码头工人<br>是判断oldTime是否超时，超时才会进行getset</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4258684,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(4258684,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="https://www.cnblogs.com/seesun2012/p/9214653.html#4285393" class="layer">#3楼</a><a name="4285393" id="comment_anchor_4285393"></a><span id="comment-maxId" style="display:none;">4285393</span><span id="comment-maxDate" style="display:none;">2019/6/23 0:58:39</span>  <span class="comment_date">2019-06-23 00:58</span> <a id="a_comment_author_4285393" href="http://home.cnblogs.com/u/1653631/" target="_blank">道天下</a> <a href="http://msg.cnblogs.com/send/%E9%81%93%E5%A4%A9%E4%B8%8B" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_4285393" class="blog_comment_body">InterProcessSemaphoreMutex</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4285393,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(4285393,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	<div id="comments_pager_bottom"></div></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id="comment_form" class="commentform">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" onclick="return RefreshCommentList();" id="lnk_RefreshComments" runat="server" clientidmode="Static">刷新评论</a><a href="https://www.cnblogs.com/seesun2012/p/9214653.html#" onclick="return RefreshPage();">刷新页面</a><a href="https://www.cnblogs.com/seesun2012/p/9214653.html#top">返回顶部</a></div>
<div id="comment_form_container"><div class="login_tips">注册用户登录后才能发表评论，请 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return login(&#39;commentform&#39;);">登录</a> 或 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return register();">注册</a>，<a href="http://www.cnblogs.com/">访问</a>网站首页。</div></div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="ad_t2"><a href="http://www.ucancode.com/index.htm" target="_blank" onclick="ga(&#39;send&#39;, &#39;event&#39;, &#39;Link&#39;, &#39;click&#39;, &#39;T2-工控&#39;)">【推荐】超50万C++/C#源码: 大型实时仿真组态图形源码</a><br><a href="http://clickc.admaster.com.cn/c/a131575,b3595121,c1705,i0,m101,8a1,8b3,h" target="_blank" onclick="ga(&#39;send&#39;, &#39;event&#39;, &#39;Link&#39;, &#39;click&#39;, &#39;T2-华为云学生&#39;)">【推荐】华为云·云创校园套餐9元起，小天鹅音箱等你来拿</a><br><a href="http://clickc.admaster.com.cn/c/a131574,b3595115,c1705,i0,m101,8a1,8b3,h" target="_blank" onclick="ga(&#39;send&#39;, &#39;event&#39;, &#39;Link&#39;, &#39;click&#39;, &#39;T2-华为云微认证&#39;)">【推荐】零基础轻松玩转云上产品，获壕礼加返百元大礼</a><br></div>
<div id="opt_under_post"></div>
<script async="async" src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/gpt.js"></script>
<script>
  var googletag = googletag || {};
  googletag.cmd = googletag.cmd || [];
</script>
<script>
  googletag.cmd.push(function() {
        googletag.defineSlot('/1090369/C1', [300, 250], 'div-gpt-ad-1546353474406-0').addService(googletag.pubads());
        googletag.defineSlot('/1090369/C2', [468, 60], 'div-gpt-ad-1539008685004-0').addService(googletag.pubads());
        googletag.pubads().enableSingleRequest();
        googletag.enableServices();
  });
</script>
<div id="cnblogs_c1" class="c_ad_block">
    <div id="div-gpt-ad-1546353474406-0" style="height:250px; width:300px;" data-google-query-id="CKnQ38Sz_eMCFUoZKgodOvcIxA"><div id="google_ads_iframe_/1090369/C1_0__container__" style="border: 0pt none;"><iframe id="google_ads_iframe_/1090369/C1_0" title="3rd party ad content" name="google_ads_iframe_/1090369/C1_0" width="300" height="250" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" style="border: 0px; vertical-align: bottom;" data-google-container-id="1" data-load-complete="true" src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/saved_resource.html"></iframe></div></div>
</div>
<div id="under_post_news"><div class="recomm-block"><b>相关博文：</b><br>·  <a href="https://www.cnblogs.com/lijiasnong/p/9951324.html" target="_blank" onclick="clickRecomItmem(9951324)">Java分布式锁看这篇就够了</a><br>·  <a href="https://www.cnblogs.com/ylxn/p/10356422.html" target="_blank" onclick="clickRecomItmem(10356422)">（五）分布式锁</a><br>·  <a href="https://www.cnblogs.com/zhisheng/p/8947996.html" target="_blank" onclick="clickRecomItmem(8947996)">分布式锁看这篇就够了</a><br>·  <a href="https://www.cnblogs.com/UncleWang001/p/10594080.html" target="_blank" onclick="clickRecomItmem(10594080)">Java分布式锁看这篇就够了</a><br>·  <a href="https://www.cnblogs.com/lijiasnong/p/9952494.html" target="_blank" onclick="clickRecomItmem(9952494)">Java分布式锁三种实现方案</a><br></div></div>
<div id="cnblogs_c2" class="c_ad_block">
    <div id="div-gpt-ad-1539008685004-0" style="height:60px; width:468px;" data-google-query-id="CNij3sSz_eMCFUoZKgodOvcIxA"><div id="google_ads_iframe_/1090369/C2_0__container__" style="border: 0pt none;"><iframe id="google_ads_iframe_/1090369/C2_0" title="3rd party ad content" name="google_ads_iframe_/1090369/C2_0" width="468" height="60" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" style="border: 0px; vertical-align: bottom;" data-google-container-id="2" data-load-complete="true" src="./Java分布式锁看这篇就够了 - seesun2012 - 博客园_files/saved_resource(1).html"></iframe></div></div>
</div>
<div id="under_post_kb"><div class="itnews c_ad_block"><b>最新新闻</b>：<br> ·  <a href="https://news.cnblogs.com/n/629551/" target="_blank">知乎周源发融资全员信强调工作效率：快则生慢则死</a><br> ·  <a href="https://news.cnblogs.com/n/629550/" target="_blank">到处作恶的台风究竟是怎么来的？背后竟藏着这些秘密…</a><br> ·  <a href="https://news.cnblogs.com/n/629549/" target="_blank">头条搜索无战事</a><br> ·  <a href="https://news.cnblogs.com/n/629548/" target="_blank">小红书否认“被下架”前正在进行新一轮融资</a><br> ·  <a href="https://news.cnblogs.com/n/629547/" target="_blank">三星发布1.08亿像素图像传感器ISOCELL Bright HMX，小米将首发</a><br>» <a href="http://news.cnblogs.com/" title="IT新闻" target="_blank">更多新闻...</a></div></div>
<div id="HistoryToday" class="c_ad_block"></div>
<script type="text/javascript">
 if(enablePostBottom()) {
    codeHighlight();
    fixPostBody();
    setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
    deliverT2();
    deliverC1();
    deliverC2();    
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);  
}
</script>
</div>

    
	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news"><div id="profile_block">昵称：<a href="https://home.cnblogs.com/u/seesun2012/">seesun2012</a><br>园龄：<a href="https://home.cnblogs.com/u/seesun2012/" title="入园时间：2018-06-22">1年1个月</a><br>粉丝：<a href="https://home.cnblogs.com/u/seesun2012/followers/">5</a><br>关注：<a href="https://home.cnblogs.com/u/seesun2012/followees/">0</a><div id="p_b_follow"><a href="javascript:void(0);" onclick="follow(&#39;264bd5e7-01cd-4a01-efb7-08d5d38bf026&#39;)">+加关注</a></div><script>getFollowStatus('264bd5e7-01cd-4a01-efb7-08d5d38bf026')</script></div></div><script type="text/javascript">loadBlogNews();</script>
</div>

			<div id="blog-calendar" style=""><table id="blogCalendar" class="Cal" cellspacing="0" cellpadding="0" title="Calendar">
	<tbody><tr><td colspan="7"><table class="CalTitle" cellspacing="0">
		<tbody><tr><td class="CalNextPrev"><a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2019/07/01&#39;);return false;">&lt;</a></td><td align="center">2019年8月</td><td class="CalNextPrev" align="right"><a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2019/09/01&#39;);return false;">&gt;</a></td></tr>
	</tbody></table></td></tr><tr><th class="CalDayHeader" align="center" abbr="日" scope="col">日</th><th class="CalDayHeader" align="center" abbr="一" scope="col">一</th><th class="CalDayHeader" align="center" abbr="二" scope="col">二</th><th class="CalDayHeader" align="center" abbr="三" scope="col">三</th><th class="CalDayHeader" align="center" abbr="四" scope="col">四</th><th class="CalDayHeader" align="center" abbr="五" scope="col">五</th><th class="CalDayHeader" align="center" abbr="六" scope="col">六</th></tr><tr><td class="CalOtherMonthDay" align="center">28</td><td class="CalOtherMonthDay" align="center">29</td><td class="CalOtherMonthDay" align="center">30</td><td class="CalOtherMonthDay" align="center">31</td><td align="center">1</td><td align="center">2</td><td class="CalWeekendDay" align="center">3</td></tr><tr><td class="CalWeekendDay" align="center">4</td><td align="center">5</td><td align="center">6</td><td align="center">7</td><td align="center">8</td><td align="center">9</td><td class="CalWeekendDay" align="center">10</td></tr><tr><td class="CalWeekendDay" align="center">11</td><td class="CalTodayDay" align="center">12</td><td align="center">13</td><td align="center">14</td><td align="center">15</td><td align="center">16</td><td class="CalWeekendDay" align="center">17</td></tr><tr><td class="CalWeekendDay" align="center">18</td><td align="center">19</td><td align="center">20</td><td align="center">21</td><td align="center">22</td><td align="center">23</td><td class="CalWeekendDay" align="center">24</td></tr><tr><td class="CalWeekendDay" align="center">25</td><td align="center">26</td><td align="center">27</td><td align="center">28</td><td align="center">29</td><td align="center">30</td><td class="CalWeekendDay" align="center">31</td></tr><tr><td class="CalOtherMonthDay" align="center">1</td><td class="CalOtherMonthDay" align="center">2</td><td class="CalOtherMonthDay" align="center">3</td><td class="CalOtherMonthDay" align="center">4</td><td class="CalOtherMonthDay" align="center">5</td><td class="CalOtherMonthDay" align="center">6</td><td class="CalOtherMonthDay" align="center">7</td></tr>
</tbody></table></div><script type="text/javascript">loadBlogDefaultCalendar();</script>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"><div id="sidebar_search" class="sidebar-block">
<div id="sidebar_search" class="mySearch">
<h3 class="catListTitle">搜索</h3>
<div id="sidebar_search_box">
<div id="widget_my_zzk" class="div_my_zzk"><input type="text" id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk">&nbsp;<input onclick="zzk_go()" type="button" value="找找看" id="btnZzk" class="btn_my_zzk"></div>
<div id="widget_my_google" class="div_my_zzk"><input type="text" name="google_q" id="google_q" onkeydown="return google_go_enter(event)" class="input_my_zzk">&nbsp;<input onclick="google_go()" type="button" value="谷歌搜索" class="btn_my_zzk"></div>
</div>
</div>

</div><div id="sidebar_shortcut" class="sidebar-block">
<div class="catListLink">
<h3 class="catListTitle">常用链接</h3>
<ul>
<li><a href="https://www.cnblogs.com/seesun2012/p/" title="我的博客的随笔列表">我的随笔</a></li><li><a href="https://www.cnblogs.com/seesun2012/MyComments.html" title="我发表过的评论列表">我的评论</a></li><li><a href="https://www.cnblogs.com/seesun2012/OtherPosts.html" title="我评论过的随笔列表">我的参与</a></li><li><a href="https://www.cnblogs.com/seesun2012/RecentComments.html" title="我的博客的评论列表">最新评论</a></li><li><a href="https://www.cnblogs.com/seesun2012/tag/" title="我的博客的标签列表">我的标签</a></li>
</ul>
<div id="itemListLin_con" style="display:none;">
<ul>

</ul>
</div>
</div></div><div id="sidebar_toptags" class="sidebar-block">
<div class="catListTag">
<h3 class="catListTitle">我的标签</h3>
<ul>
<li><a href="https://www.cnblogs.com/seesun2012/tag/Java/">Java</a>(18)</li><li><a href="https://www.cnblogs.com/seesun2012/tag/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a>(7)</li><li><a href="https://www.cnblogs.com/seesun2012/tag/JavaScript/">JavaScript</a>(2)</li><li><a href="https://www.cnblogs.com/seesun2012/tag/Linux/">Linux</a>(1)</li><li><a href="https://www.cnblogs.com/seesun2012/tag/MySQL/">MySQL</a>(1)</li><li><a href="https://www.cnblogs.com/seesun2012/tag/Oracle/">Oracle</a>(1)</li><li><a href="https://www.cnblogs.com/seesun2012/tag/SVN/">SVN</a>(1)</li><li><a href="https://www.cnblogs.com/seesun2012/tag/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a>(1)</li><li><a href="https://www.cnblogs.com/seesun2012/tag/%E5%8C%BA%E5%9D%97%E9%93%BE/">区块链</a>(1)</li><li><a href="https://www.cnblogs.com/seesun2012/tag/%E7%AE%97%E6%B3%95/">算法</a>(1)</li><li><a href="https://www.cnblogs.com/seesun2012/tag/">更多</a></li>
</ul>
</div></div><div id="sidebar_categories">
<div id="sidebar_postarchive" class="catListPostArchive sidebar-block">
<h3 class="catListTitle">随笔档案</h3>

<ul>

<li><a id="CatList_LinkList_0_Link_0" href="https://www.cnblogs.com/seesun2012/archive/2018/06.html">2018年6月 (26)</a> </li>

</ul>

</div>

</div><div id="sidebar_recentcomments" class="sidebar-block"><div id="recent_comments_wrap">
<div class="catListComment">
<h3 class="catListTitle">最新评论</h3>

	<div id="RecentCommentsBlock"><ul>
        <li class="recent_comment_title"><a href="https://www.cnblogs.com/seesun2012/p/9214653.html#4285393">1. Re:Java分布式锁看这篇就够了</a></li>
        <li class="recent_comment_body">InterProcessSemaphoreMutex</li>
        <li class="recent_comment_author">--道天下</li>
        <li class="recent_comment_title"><a href="https://www.cnblogs.com/seesun2012/p/9214653.html#4258684">2. Re:Java分布式锁看这篇就够了</a></li>
        <li class="recent_comment_body">@码头工人是判断oldTime是否超时，超时才会进行getset...</li>
        <li class="recent_comment_author">--hhq1991</li>
        <li class="recent_comment_title"><a href="https://www.cnblogs.com/seesun2012/p/9214653.html#4236490">3. Re:Java分布式锁看这篇就够了</a></li>
        <li class="recent_comment_body">你好。currentTime != oldTime，使用getset，不就会覆盖超时时间了吗？</li>
        <li class="recent_comment_author">--码头工人</li>
</ul>
</div>
</div>
</div></div><div id="sidebar_topviewedposts" class="sidebar-block"><div id="topview_posts_wrap">
<div class="catListView">
<h3 class="catListTitle">阅读排行榜</h3>
	<div id="TopViewPostsBlock"><ul><li><a href="https://www.cnblogs.com/seesun2012/p/9214653.html">1. Java分布式锁看这篇就够了(50455)</a></li><li><a href="https://www.cnblogs.com/seesun2012/p/9214702.html">2. svn 不能校验路径“XXX”的锁；没有匹配的可用锁令牌 故障解决方法(758)</a></li><li><a href="https://www.cnblogs.com/seesun2012/p/9214961.html">3. js文件加载太慢，JavaScript文件加载加速(717)</a></li><li><a href="https://www.cnblogs.com/seesun2012/p/9214738.html">4. java 大文件上传 断点续传 完整版实例 （Socket、IO流）(606)</a></li><li><a href="https://www.cnblogs.com/seesun2012/p/9214672.html">5. Linux常用命令语法+示例(597)</a></li></ul></div>
</div>
</div></div><div id="sidebar_topcommentedposts" class="sidebar-block"><div id="topfeedback_posts_wrap">
<div class="catListFeedback">
<h3 class="catListTitle">评论排行榜</h3>
	<div id="TopFeedbackPostsBlock"><ul><li><a href="https://www.cnblogs.com/seesun2012/p/9214653.html">1. Java分布式锁看这篇就够了(3)</a></li></ul></div>
</div>
</div></div><div id="sidebar_topdiggedposts" class="sidebar-block"><div id="topdigg_posts_wrap">
<div class="catListView">
<h3 class="catListTitle">推荐排行榜</h3>
<div id="TopDiggPostsBlock"><ul><li><a href="https://www.cnblogs.com/seesun2012/p/9214653.html">1. Java分布式锁看这篇就够了(11)</a></li></ul></div>
</div></div></div></div><script type="text/javascript">loadBlogSideColumn();</script>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright ©2019 seesun2012
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->



</body></html>